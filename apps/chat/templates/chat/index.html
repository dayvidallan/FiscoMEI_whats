
{% extends "base.html" %}
{% load static %}
{% block header %}<h1>Chat</h1>{% endblock %}
{% block content %}
<style>
.chat-wrap{display:grid;grid-template-rows:1fr auto;gap:10px;height:70vh}
.chat-box{background:#e5ddd5;border:1px solid #d1d5db;border-radius:14px;overflow:auto;padding:14px}
.msg{max-width:70%;padding:10px 12px;border-radius:12px;margin:6px 0;line-height:1.3;background:#fff}
.msg.user{background:#dcf8c6;margin-left:auto}
.msg.bot{background:#fff;margin-right:auto}
.chat-input{display:grid;grid-template-columns:1fr auto;gap:8px}
</style>
<div class="chat-wrap card">
  <div id="chat" class="chat-box">
    <div id="loading">Carregando...</div>
  </div>
  <form id="chat-form" class="chat-input">
    {% csrf_token %}
    <input id="chat-text" name="content" autocomplete="off" placeholder="Escreva uma mensagem..." />
    <button class="btn primary" type="submit">Enviar</button>
  </form>
</div>
<script>
const chat = document.getElementById('chat');
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-text');
let lastId = 0;
function render(msg){
  const div = document.createElement('div');
  div.className = 'msg ' + (msg.role === 'user' ? 'user' : 'bot');
  div.textContent = msg.content;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  lastId = Math.max(lastId, msg.id);
}
async function fetchMessages(){
  const r = await fetch("{% url 'chat:messages_api' %}?after=" + lastId);
  const data = await r.json();
  if (document.getElementById('loading')) document.getElementById('loading').remove();
  data.messages.forEach(render);
}
setInterval(fetchMessages, 1500);
fetchMessages();
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = input.value.trim();
  if(!text) return;
  const fd = new FormData(form);
  const r = await fetch("{% url 'chat:messages_api' %}", { method:'POST', body: fd });
  input.value='';
  await fetchMessages();
});
</script>
{% endblock %}
